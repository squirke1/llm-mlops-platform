name: CI Pipeline

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop, main]
  workflow_dispatch:

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
      - name: Install linting tools
        run: |
          pip install black==23.12.1 flake8==7.0.0 isort==5.13.2 mypy==1.8.0
      - name: Run linters
        run: |
          black --check src/ api/ feature_store/ tests/
          isort --check-only src/ api/ feature_store/ tests/
          flake8 src/ api/ feature_store/ tests/

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      - name: Train model for tests
        run: |
          cd src && python train.py
      - name: Run tests
        run: |
          pytest tests/ -v

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Build Docker image
        run: |
          docker build -t churn-prediction-api:test .

  validate-k8s:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v1
        with:
          kustomize-version: "5.3.0"

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Install kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz \
            | tar -xz -C /usr/local/bin kubeconform

      - name: Validate Kubernetes YAML
        run: |
          # Render kustomize locally and validate client-side (no cluster required)
          kustomize build k8s/ > /tmp/k8s-rendered.yaml
          kubeconform -strict -summary -kubernetes-version 1.28.0 /tmp/k8s-rendered.yaml

  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [lint, test, docker, validate-k8s, validate-terraform]
    if: always()

    steps:
      - name: Check all jobs succeeded
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.docker.result }}" != "success" ] || \
             [ "${{ needs.validate-k8s.result }}" != "success" ] || \
             [ "${{ needs.validate-terraform.result }}" != "success" ]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
