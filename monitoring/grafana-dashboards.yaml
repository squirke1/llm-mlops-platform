apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: mlops-platform
data:
  api-overview.json: |
    {
        "dashboard": {
            "title": "Churn Prediction API - Overview",
            "uid": "churn-api-overview",
            "timezone": "browser",
            "schemaVersion": 16,
            "version": 0,
            "refresh": "10s",
            "panels": [
                {
                    "id": 1,
                    "title": "Request Rate",
                    "type": "graph",
                    "gridPos": {
                        "x": 0,
                        "y": 0,
                        "w": 12,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "rate(http_requests_total{job=\"churn-api\"}[5m])",
                            "legendFormat": "{{method}} {{handler}}"
                        }
                    ]
                },
                {
                    "id": 2,
                    "title": "Request Duration (95th percentile)",
                    "type": "graph",
                    "gridPos": {
                        "x": 12,
                        "y": 0,
                        "w": 12,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=\"churn-api\"}[5m]))",
                            "legendFormat": "{{handler}}"
                        }
                    ]
                },
                {
                    "id": 3,
                    "title": "Total Predictions",
                    "type": "stat",
                    "gridPos": {
                        "x": 0,
                        "y": 8,
                        "w": 6,
                        "h": 4
                    },
                    "targets": [
                        {
                            "expr": "sum(churn_predictions_total)"
                        }
                    ]
                },
                {
                    "id": 4,
                    "title": "Prediction Rate",
                    "type": "graph",
                    "gridPos": {
                        "x": 6,
                        "y": 8,
                        "w": 18,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "rate(churn_predictions_total[5m])",
                            "legendFormat": "{{prediction_result}}"
                        }
                    ]
                },
                {
                    "id": 5,
                    "title": "Churn Rate",
                    "type": "gauge",
                    "gridPos": {
                        "x": 0,
                        "y": 16,
                        "w": 6,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "rate(churn_predictions_total{prediction_result=\"churn\"}[1h]) / rate(churn_predictions_total[1h])"
                        }
                    ],
                    "fieldConfig": {
                        "defaults": {
                            "unit": "percentunit",
                            "min": 0,
                            "max": 1,
                            "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                    {
                                        "value": 0,
                                        "color": "green"
                                    },
                                    {
                                        "value": 0.3,
                                        "color": "yellow"
                                    },
                                    {
                                        "value": 0.6,
                                        "color": "red"
                                    }
                                ]
                            }
                        }
                    }
                },
                {
                    "id": 6,
                    "title": "Model Confidence",
                    "type": "graph",
                    "gridPos": {
                        "x": 6,
                        "y": 16,
                        "w": 18,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "churn_model_confidence",
                            "legendFormat": "Confidence Score"
                        }
                    ],
                    "fieldConfig": {
                        "defaults": {
                            "unit": "percentunit",
                            "min": 0,
                            "max": 1
                        }
                    }
                },
                {
                    "id": 7,
                    "title": "Error Rate",
                    "type": "graph",
                    "gridPos": {
                        "x": 0,
                        "y": 24,
                        "w": 12,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "rate(http_requests_total{job=\"churn-api\",status=~\"5..\"}[5m])",
                            "legendFormat": "5xx errors"
                        },
                        {
                            "expr": "rate(http_requests_total{job=\"churn-api\",status=~\"4..\"}[5m])",
                            "legendFormat": "4xx errors"
                        }
                    ]
                },
                {
                    "id": 8,
                    "title": "Predictions in Progress",
                    "type": "stat",
                    "gridPos": {
                        "x": 12,
                        "y": 24,
                        "w": 6,
                        "h": 4
                    },
                    "targets": [
                        {
                            "expr": "churn_predictions_in_progress"
                        }
                    ]
                },
                {
                    "id": 9,
                    "title": "Prediction Latency Distribution",
                    "type": "heatmap",
                    "gridPos": {
                        "x": 0,
                        "y": 32,
                        "w": 24,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "rate(churn_prediction_duration_seconds_bucket[5m])",
                            "format": "heatmap",
                            "legendFormat": "{{le}}"
                        }
                    ]
                }
            ]
        }
    }  model-performance.json: |
    {
        "dashboard": {
            "title": "Churn Model Performance",
            "uid": "churn-model-performance",
            "timezone": "browser",
            "schemaVersion": 16,
            "version": 0,
            "refresh": "30s",
            "panels": [
                {
                    "id": 1,
                    "title": "Prediction Distribution",
                    "type": "piechart",
                    "gridPos": {
                        "x": 0,
                        "y": 0,
                        "w": 8,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "sum by (prediction_result) (churn_predictions_total)",
                            "legendFormat": "{{prediction_result}}"
                        }
                    ]
                },
                {
                    "id": 2,
                    "title": "Hourly Churn Rate Trend",
                    "type": "graph",
                    "gridPos": {
                        "x": 8,
                        "y": 0,
                        "w": 16,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "rate(churn_predictions_total{prediction_result=\"churn\"}[1h]) / rate(churn_predictions_total[1h])",
                            "legendFormat": "Churn Rate"
                        }
                    ],
                    "fieldConfig": {
                        "defaults": {
                            "unit": "percentunit"
                        }
                    }
                },
                {
                    "id": 3,
                    "title": "Average Model Confidence",
                    "type": "stat",
                    "gridPos": {
                        "x": 0,
                        "y": 8,
                        "w": 6,
                        "h": 6
                    },
                    "targets": [
                        {
                            "expr": "avg_over_time(churn_model_confidence[5m])"
                        }
                    ],
                    "fieldConfig": {
                        "defaults": {
                            "unit": "percentunit",
                            "decimals": 2,
                            "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                    {
                                        "value": 0,
                                        "color": "red"
                                    },
                                    {
                                        "value": 0.6,
                                        "color": "yellow"
                                    },
                                    {
                                        "value": 0.8,
                                        "color": "green"
                                    }
                                ]
                            }
                        }
                    }
                },
                {
                    "id": 4,
                    "title": "Predictions per Hour",
                    "type": "stat",
                    "gridPos": {
                        "x": 6,
                        "y": 8,
                        "w": 6,
                        "h": 6
                    },
                    "targets": [
                        {
                            "expr": "increase(churn_predictions_total[1h])"
                        }
                    ]
                },
                {
                    "id": 5,
                    "title": "Prediction Latency (p50, p95, p99)",
                    "type": "graph",
                    "gridPos": {
                        "x": 12,
                        "y": 8,
                        "w": 12,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "histogram_quantile(0.50, rate(churn_prediction_duration_seconds_bucket[5m]))",
                            "legendFormat": "p50"
                        },
                        {
                            "expr": "histogram_quantile(0.95, rate(churn_prediction_duration_seconds_bucket[5m]))",
                            "legendFormat": "p95"
                        },
                        {
                            "expr": "histogram_quantile(0.99, rate(churn_prediction_duration_seconds_bucket[5m]))",
                            "legendFormat": "p99"
                        }
                    ],
                    "fieldConfig": {
                        "defaults": {
                            "unit": "s"
                        }
                    }
                },
                {
                    "id": 6,
                    "title": "Confidence Score Distribution",
                    "type": "graph",
                    "gridPos": {
                        "x": 0,
                        "y": 16,
                        "w": 24,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "churn_model_confidence",
                            "legendFormat": "Confidence"
                        }
                    ],
                    "fieldConfig": {
                        "defaults": {
                            "unit": "percentunit",
                            "min": 0,
                            "max": 1
                        }
                    }
                },
                {
                    "id": 7,
                    "title": "Daily Prediction Volume",
                    "type": "bargauge",
                    "gridPos": {
                        "x": 0,
                        "y": 24,
                        "w": 12,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "increase(churn_predictions_total[24h])",
                            "legendFormat": "{{prediction_result}}"
                        }
                    ]
                },
                {
                    "id": 8,
                    "title": "Prediction Success Rate",
                    "type": "stat",
                    "gridPos": {
                        "x": 12,
                        "y": 24,
                        "w": 12,
                        "h": 8
                    },
                    "targets": [
                        {
                            "expr": "1 - (rate(http_requests_total{job=\"churn-api\",handler=\"/api/v1/predict\",status=~\"5..\"}[5m]) / rate(http_requests_total{job=\"churn-api\",handler=\"/api/v1/predict\"}[5m]))"
                        }
                    ],
                    "fieldConfig": {
                        "defaults": {
                            "unit": "percentunit",
                            "decimals": 2,
                            "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                    {
                                        "value": 0,
                                        "color": "red"
                                    },
                                    {
                                        "value": 0.95,
                                        "color": "yellow"
                                    },
                                    {
                                        "value": 0.99,
                                        "color": "green"
                                    }
                                ]
                            }
                        }
                    }
                }
            ]
        }
    }